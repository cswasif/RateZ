name: Build WASM Module

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: wasm32-unknown-unknown
    
    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
    
    - name: Fetch dependencies
      run: |
        cd packages/zk-wasm
        cargo fetch
    
    - name: Build WASM module
      run: |
        cd packages/zk-wasm
        wasm-pack build --target web --out-dir ../frontend/src/lib/zk-wasm-pkg
    
    - name: Upload WASM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zk-wasm-package
        path: packages/frontend/src/lib/zk-wasm-pkg/
        retention-days: 30
    
    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: packages/frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd packages/frontend
        npm install
    
    - name: Build frontend
      run: |
        cd packages/frontend
        npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: packages/frontend/dist/
        retention-days: 30